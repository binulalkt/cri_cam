<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caricature Photobooth</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-image: url('static/bg3.jpg');
            /* Add your background image URL */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: #333;
            height: 100%;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            /* Added for positioning the overlay */
        }

        h1 {
            text-align: center;
            font-size: 3em;
            margin-bottom: 20px;
        }



        .main-display {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: auto;
            /* Fixed height */
            margin-bottom: 20px;
            position: relative;
            background-color: #ffffff00;
        }

        .side-container {
            position: relative;
            width: 100px;
            height: 100px;
            background-color: #ffffff00;
        }

        .side-img {
            width: 100px;
            height: 100px;
        }

        #qrcode {
            width: 100px;
            height: 100px;
            position: absolute;
            top: 0;
            left: 0;
            display: none;
            /* Initially hidden */
        }

        #status {
            text-align: center;
            margin-top: 20px;
        }

        #capturedImage,
        #generatedCaricature,
        video {
                       width: 540px;
            height: 960px;
            object-fit: contain;
            display: none;
            background-color: #ffffff3e;
        }
               #capturedImage,
        video {
         transform: rotate(90deg);
        }

        #capturedImage.active,
        #generatedCaricature.active,
        video.active {
            display: block;
        }

        #loading {
            display: none;
            text-align: center;
            margin-top: 10px;
        }

        #loading img {
            width: 50px;
            height: 50px;
        }

        canvas {
            display: none;
        }

        /* Overlay styles */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 999;
            /* Make sure it's on top */
        }

        .countdown {
            font-size: 5em;
            color: white;
        }

        .hidden {
            display: none;
        }

        #capture:hover,
        #generate:hover,
        #newCaricature:hover {
            color: #de0f0f;
        }
    </style>
</head>

<body>
    <!-- <style>
        .container {
            display: none;
        }
    </style>

    <script>
        document.addEventListener('mousemove', function () {
            document.querySelector('.container').style.display = 'block';
        });
    </script> -->

    <img src="static/chairman.png"
        style="width:auto; height: 15%; display: block; margin: 0 auto;" alt="Caricature Photo Maker Online">
    <div class="container">
        <input type="hidden" id="styleImageUrl" value="1" />
        <div class="main-display" style="padding-top: 15%; border: 1px solid #ccc; border-radius: 16px; box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);">
            <div class="side-container" id="side-container">
                <div id="qrcode"></div> <!-- QR code will be placed here -->
            </div>
            <video id="webcam" autoplay playsinline class="active"
                style="width: 720px; height: 640px; border: none; background: rgba(240, 240, 240, 0.1); border-radius: 16px; box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);"></video>
            <img id="capturedImage" src="" alt="Captured Image"
                style="border-radius: 16px; border: none; background: rgba(240, 240, 240, 0.1); box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);" />
            <div style="position: relative; z-index: 1;">
                <img id="generatedCaricature" src="" alt="Generated Caricature"
                    style="border-radius: 16px; border: none; background: rgba(240, 240, 240, 0.1); box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);" />
                <div
                    style="position: absolute; top: 50%;padding-left:10px; right: 0; transform: translateY(-50%); z-index: 10; display: flex; gap: 10px; flex-direction: column; align-items: center;">
                    <button id="showQrCode" class="hidden"
                        style="z-index: 11; background-color: transparent; border: none;">
                        <img src="static/qr-icon.png"
                            style="width: 80px; height: 80px; border-radius: 50%; cursor: pointer;" />
                    </button>
                    <button id="printCaricature" class="hidden"
                        style="z-index: 11; background-color: transparent; border: none;">
                        <img src="static/print.jpg"
                            style="width: 80px; height: 80px; border-radius: 50%; cursor: pointer;" />
                    </button>
                </div>
            </div>
        </div>

        <canvas id="canvas" width="700" height="600"></canvas>

        <div
            style="position: absolute; top: -12%; left: 2%; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; gap: 0px;">
            <button id="capture"
                style="width: 21.5%; height: 80%; font-family: 'Comic Sans MS', 'Comic Sans', cursive; font-size: 1.5em; color: rgba(255, 255, 255, 0); background-color: #ffffff00; border: none; border-radius: 4px; padding: 10px 20px; cursor: pointer; transition: all 0.3s ease-in-out;">
                C
            </button>
            <button id="generate"
                style="width: 21.5%; height: 80%; font-family: 'Comic Sans MS', 'Comic Sans', cursive; font-size: 1.5em; color: rgba(255, 255, 255, 0.7); background-color: #ffffff00; border: none; border-radius: 4px; padding: 10px 20px; cursor: pointer; transition: all 0.3s ease-in-out; z-index: 3;"
                disabled>Generate Caricature</button>
            <button id="newCaricature" class="hidden"
                style="width: 21.5%; height: 80%; font-family: 'Comic Sans MS', 'Comic Sans', cursive; font-size: 1.5em; color: rgba(255, 255, 255, 0.7); background-color: #ffffff00; border: none; border-radius: 4px; padding: 10px 20px; cursor: pointer; transition: all 0.3s ease-in-out; z-index: 3;">New
                Caricature</button>

        </div>

        <div id="loading" style="display: none;">
            <p>Generating caricature... please wait</p>
            <!-- <img src="/static/loading.gif" alt="Loading" style="width: 50px; height: 50px;"> -->
        </div>

        <p id="status" style="display: none;"></p>

        <!-- Overlay for loading animation -->
        <div id="overlay">
            <div>
                <p class="countdown" id="countdownDisplay">5</p>
                <img src="/static/loading.gif" alt="Loading" style="width: 50px; height: 50px;">
            </div>
        </div>
    </div>

    <script>
        const webcamElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('canvas');
        const capturedImageElement = document.getElementById('capturedImage');
        const generatedCaricatureElement = document.getElementById('generatedCaricature');
        const captureButton = document.getElementById('capture');
        const generateButton = document.getElementById('generate');
        const statusElement = document.getElementById('status');
        const qrCodeContainer = document.getElementById('qrcode');
        const loadingElement = document.getElementById('loading');
        const sideImgLeft = document.getElementById('side-img-left');
        const overlay = document.getElementById('overlay');
        const countdownDisplay = document.getElementById('countdownDisplay');
        const newCaricatureButton = document.getElementById('newCaricature');
        const sideContainer = document.getElementById('side-container');
        let resultUrl = '';
        newCaricatureButton.style.display = 'none';
        generateButton.style.display = 'none';
        let isGeneratedOnce = false;
        let change_button=false;
        // function showQrCodeInNewWindow() {}
        const constraints = {
            video: true
        };

        navigator.mediaDevices.getUserMedia(constraints).then((stream) => {
            webcamElement.srcObject = stream;
        });

        function startCountdown(seconds, callback) {
            let countdown = seconds;
            countdownDisplay.textContent = countdown;
            const interval = setInterval(() => {
                countdown--;
                countdownDisplay.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(interval);
                    callback();
                    const flash = document.createElement('div');
                    flash.style.position = 'fixed';
                    flash.style.top = '0';
                    flash.style.right = '0';
                    flash.style.bottom = '0';
                    flash.style.left = '0';
                    flash.style.backgroundColor = 'white';
                    document.body.appendChild(flash);
                    setTimeout(() => {
                        document.body.removeChild(flash);
                    }, 1000);
                }
                
            }, 1000);
        }

        captureButton.addEventListener('click', () => {
            overlay.style.display = 'flex';
            loadingElement.firstChild.src = 'static/camera.gif';
            setTimeout(() => {
                console.error('Capture button pressed');
                loadingElement.firstChild.src = 'static/loading.gif';
            }, 2000);
            
            // overlay.style.display = 'flex'; // Show overlay
            console.error('Capture button pressed');
            capturedImageElement.classList.remove('active');
            webcamElement.classList.add('active');
            startCountdown(5, () => {
                const context = canvasElement.getContext('2d');
                context.drawImage(webcamElement, 0, 0, canvasElement.width, canvasElement.height);
                const imageDataURL = canvasElement.toDataURL('image/jpeg');
                capturedImageElement.src = imageDataURL;

                webcamElement.classList.remove('active');
                capturedImageElement.classList.add('active');
                overlay.style.display = 'none'; // Hide overlay

                generateButton.style.display = 'flex';
                generateButton.style.backgroundColor = 'rgba(40, 167, 69, 0.5)';
                generateButton.style.color = '#fff';
                generateButton.style.border = 'none';
                generateButton.style.borderRadius = '10px';
                generateButton.style.padding = '10px 20px';
                generateButton.style.cursor = 'pointer';
                generateButton.style.height = '80px';
                generateButton.style.width = '260px';
                generateButton.style.position = 'fixed';
                generateButton.style.bottom = '35px';
                generateButton.style.boxShadow = '0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19)';
                generateButton.style.transition = 'all 0.3s ease-in-out';
                generateButton.disabled = false;
                captureButton.style.position = 'flex';
                captureButton.style.transform = 'translate(80%, -31%)';
                captureButton.style.zIndex = '11';
                captureButton.textContent = 'X';
            });
        });

        function dataURLToBlob(dataURL) {
            const parts = dataURL.split(',');
            const mimeType = parts[0].match(/:(.*?);/)[1];
            const byteString = atob(parts[1]);
            const arrayBuffer = new ArrayBuffer(byteString.length);
            const uint8Array = new Uint8Array(arrayBuffer);

            for (let i = 0; i < byteString.length; i++) {
                uint8Array[i] = byteString.charCodeAt(i);
            }

            return new Blob([uint8Array], { type: mimeType });
        }

        generateButton.addEventListener('click', () => {
            if (isGeneratedOnce) return;
            isGeneratedOnce = true;
            console.log('generate button pressed');
            const imageDataURL = capturedImageElement.src;

            if (!imageDataURL) {
                statusElement.textContent = 'Please capture an image first!';
                return;
            }

            const blob = dataURLToBlob(imageDataURL);

            const formData = new FormData();
            formData.append('imageFile', blob, 'captured_image.jpg');

            countdownDisplay.style.display = 'none';
            loadingElement.style.display = 'block'; // Show loading animation
            generateButton.classList.add('hidden'); // Hide generate button
            captureButton.classList.add('hidden'); // Hide capture button too

            overlay.style.display = 'flex'; // Show overlay

            fetch('/upload_image', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const imageUrl = data.imageUrl;
                        generateCaricature(imageUrl);
                        generateButton.textContent = 'New Caricature';
                        change_button=true;
                        
                    } else {
                        statusElement.textContent = `Error: ${data.message}. Contact Photobooth authority.`;
                        loadingElement.style.display = 'none'; // Hide loading animation
                        overlay.style.display = 'none'; // Hide overlay
                        generateButton.style.display = 'none'; // Hide generate button
                    }
                })
                .catch(err => {
                    statusElement.textContent = `Error: ${err}. Contact Photobooth authority.`;
                    loadingElement.style.display = 'none'; // Hide loading animation
                    overlay.style.display = 'none'; // Hide overlay
                });
        });

        function generateCaricature(imageUrl) {
            const formData = new FormData();
            formData.append('imageUrl', imageUrl);
            formData.append('styleImageUrl', '1');

            fetch('/generate_caricature', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'processing') {
                        statusElement.textContent = `Processing... Order ID: ${data.orderId}`;
                        startPolling(data.orderId);
                    } else {
                        statusElement.textContent = `Error: ${data.message}. Contact Photobooth authority.`;
                        loadingElement.style.display = 'none'; // Hide loading animation
                        overlay.style.display = 'none'; // Hide overlay
                    }
                })
                .catch(err => {
                    statusElement.textContent = `Error: ${err}. Contact Photobooth authority.`;
                    loadingElement.style.display = 'none'; // Hide loading animation
                    overlay.style.display = 'none'; // Hide overlay
                });
        }


        function startPolling(orderId) {

            fetch(`/check_status/${orderId}`)
                .then(response => response.json())
                .then(statusData => {
                    if (statusData.status === 'active') {

                        resultUrl = statusData.output;
                        statusElement.textContent = 'Caricature ready!';

                        // Hide captured image and show generated caricature
                        capturedImageElement.classList.remove('active');
                        // Set the src attribute of the generated caricature element to the result URL
                        const generatedCaricatureImg = document.getElementById('generatedCaricature');
                        generatedCaricatureImg.src = resultUrl;
                        // Show the generated caricature element
                        generatedCaricatureElement.classList.add('active');
                        loadingElement.style.display = 'none';
                        qrCodeContainer.innerHTML = '';
                        qrCodeContainer.style.display = 'none';  // Show QR code
                        new QRCode(qrCodeContainer, {
                            text: resultUrl,
                            width: 720,
                            height: 720,
                            style: {
                                position: 'absolute',
                                left: '50%',
                                top: '50%',
                                transform: 'translate(-50%, -50%)'
                            }
                        });
                        console.log(`Result URL: ${resultUrl}`);

                        // setupQrCode(resultUrl); 
                        document.getElementById('showQrCode').classList.remove('hidden');
                        document.getElementById('printCaricature').classList.remove('hidden');
                        newCaricatureButton.classList.remove('hidden'); // Show New Caricature button
                        // Pass resultUrl from within the context where it's defined
                        // Show buttons after QR code is generated
                        sideImgLeft.style.display = 'none';  // Hide left side image
                        // Auto-download caricature image
                        fetch(resultUrl)
                            .then(response => response.blob())
                            .then(blob => {
                                // Create an URL pointing to the blob, which allows the browser to download it
                                // This is necessary because the blob is not a file on the server, but rather a
                                // temporary object in memory that can be accessed via this URL
                                // Create an URL pointing to the blob, which allows the browser to download it
                                // This is necessary because the blob is not a file on the server, but rather a
                                // temporary object in memory that can be accessed via this URL
                                const url = window.URL.createObjectURL(blob);
                                // Create an anchor element to download the blob
                                const link = document.createElement('a');
                                link.href = url;
                                // Set the download attribute to the filename and extension
                                link.download = `cartoons/caricature_${orderId}.jpg`;
                                // Simulate a click event on the anchor element to download the blob
                                link.click();
                                // Revoke the URL to free up memory
                                window.URL.revokeObjectURL(url);
                                console.log(`Result URL: ${resultUrl}`);
                                // Create an image element to display the downloaded image
                                const image = document.createElement('img');
                                image.src = url;
                                image.alt = `Generated Caricature for order ID ${orderId}`;
                                // Empty the generated caricature container and append the image element
                                generatedCaricatureElement.innerHTML = '';
                                generatedCaricatureElement.appendChild(image);
                            });
                        loadingElement.style.display = 'none'; // Hide loading animation
                        overlay.style.display = 'none'; // Hide overlay


                        // Function to print the generated caricature
                        function printGeneratedCaricature() {
                            const generatedCaricatureImg = document.getElementById('generatedCaricature');
                            const bodyContent = document.body.innerHTML;  // Store original page content
                            // Prepare the page to show only the image for printing
                            document.body.innerHTML = `<img src="${generatedCaricatureImg.src}" style="width:100%; height:auto;">`;

                            window.print();  // Print the image

                            // Restore the original page content after printing
                            document.body.innerHTML = bodyContent;
                        }
                        // Add event listener to the print button
                        document.getElementById('printCaricature').addEventListener('click', printGeneratedCaricature);

                        // Auto refresh after 30 seconds
                        setTimeout(() => {
                            location.reload();
                        }, 50000);
                    } else {
                        statusElement.textContent = 'Still processing...';
                    }
                })
                .catch(err => {
                    // clearInterval(pollingInterval);
                    statusElement.textContent = `Error: ${err}. Contact Photobooth authority.`;
                    loadingElement.style.display = 'none'; // Hide loading animation
                    overlay.style.display = 'none'; // Hide overlay
                });

            document.getElementById('showQrCode').addEventListener('click', () => {
                qrCodeContainer.style.display = 'flex';  // Show overlay
                showQrCodeInNewWindow();
                console.log(` URL: ${resultUrl}`);
            });    // Call this after generating the QR code
        }

        function showQrCodeInNewWindow() {
            const qrCodeWindow = window.open("", "QR Code", "width=800,height=800,top=" + (screen.height / 2 - 400) + ",left=" + (screen.width / 2 - 400));
            qrCodeWindow.document.write("<div style='display: flex; justify-content: center; align-items: center; height: 100vh;'><div id='qrCodeContainer'></div></div>");
            new QRCode(qrCodeWindow.document.getElementById('qrCodeContainer'), {
                text: resultUrl,
                width: 720,
                height: 720,
                style: {
                    position: 'absolute',
                    left: '50%',
                    top: '50%',
                    transform: 'translate(-50%, -50%)',
                    zIndex: '199'
                }
            });
            document.addEventListener('click', () => qrCodeContainer.style.display = 'none');
        }


        // Hide overlay when clicked anywhere on the screen
        document.addEventListener('click', () => qrCodeContainer.style.display = 'none');

        document.getElementById('printCaricature').addEventListener('click', () => {
            const generatedCaricatureImg = document.getElementById('generatedCaricature');
            const bodyContent = document.body.innerHTML;  // Store original page content

            // Prepare the page to show only the image for printing
            document.body.innerHTML = `<img src="${generatedCaricatureImg.src}" style="width:100%; height:auto;">`;

            window.print();  // Print the image

            // Restore the original page content after printing
            // Restore the original page content after printing
            // This is required because the print method will not work if the page content is not restored
            document.body.innerHTML = bodyContent;

        });



        newCaricatureButton.addEventListener('click', () => {

            if (event.target.id === 'change_button') {
                location.reload(); // Refresh the page
            }
        });

    </script>
</body>

</html>
